@page "/"

@using System;
@using System.Net;
@using RegistroVacunas.Data;
@using Newtonsoft.Json;
@using Models;

<h1>Registro de vacunas</h1>

<p>Digite su cedula: <input type="text" @bind="@cedula"> <button class="btn btn-primary" @onclick="ValidarCedula">Buscar</button></p>

@if (validacion == 1)
{
    if (nombre != "")
    {
        <p>Nombre: @nombre</p>
        <p>Apellido: @apellido</p>
        <p>cedula: @cedula</p>
        <p>Fecha de nacimiento: @fecha</p>
        <p>Digite su Telefono: <input type="text" @bind="@telefono"></p>
        <p>
            Vacuna  <select class="form-select form-select-lg mb-3" aria-label=".form-select-lg example" @bind="vacuna">
                <option selected>Vacunas</option>
                <option value="Sarampion">Sarampion</option>
                <option value="Rotavirus">Rotavirus</option>
                <option value="viruela">Viruela</option>
                <option value="Fiebre amarilla">Fiebre Amarilla</option>
                <option value="Rabia">Rabia</option>
                <option value="Polio">Polio</option>
                <option value="Gripe">gripe</option>
                <option value="Hepatitis A">Hepatitis A</option>
            </select>
        </p>
        <p>Provincia: <select class="form-select form-select-sm" aria-label=".form-select-sm example" @bind="provincia">
            <option selected>Provincias</option>
            <option value="Azua-">Azua</option>
            <option value="Bahoruco">Bahoruco</option>
            <option value="Barahona">Barahona</option>
            <option value="Dajabon">Dajabon</option>
            <option value="Distrito Nacional">Distrito Nacional</option>
            <option value="Duarte">Duarte</option>
            <option value="Elias Piña">Elias Piña</option>
            <option value="El Seibo">El Seibo</option>
            <option value="Espaillat">Espaillat</option>
            <option value="Hato Mayor">Hato Mayor</option>
            <option value="Hermanas Mirabal">Hermanas Mirabal</option>
            <option value="Independencia">Independencia</option>
            <option value="La Altagracia">La Altagracia</option>
            <option value="La Romana">La Romana</option>
            <option value="La Vega">La Vega</option>
            <option value="Maria Trinidad Sanchez">Maria Trinidad Sanchez</option>
            <option value="Monseñor Nouel">Monseñor Nouel</option>
            <option value="Monte Cristi">Monte Cristi</option>
            <option value="Monte Plata">Monte Plata</option>
            <option value="Pedernales">Pedernales</option>
            <option value="Peravia">Peravia</option>
            <option value="Puerto Plata">Puerto Plata</option>
            <option value="Samana">Samana</option>
            <option value="Sanchez Ramirez">Sanchez Ramirez</option>
            <option value="San Cristobal">San Cristobal</option>
            <option value="San Jose de Ocoa">San Jose de Ocoa</option>
            <option value="3">San Juan</option>
            <option value="San Juan">San Pedro de Macoris</option>
            <option value="Santiago">Santiago</option>
            <option value="Santiago Rodrigez">Santiago Rodrigez</option>
            <option value="Santo Domingo">Santo Domingo</option>
            <option value="Valverde">Valverde</option>

        </select></p>
<button class="btn btn-secondary" @onclick="Registrar">Registrar</button>

    }
    else
    {
        <p>cedula: @cedula</p>
        <p>Digite su nombre: <input type="text" @bind="@nombre"></p>
        <p>Digite su Apellido: <input type="text" @bind="@apellido"></p>
        <p>Digite su Fecha: <input type="text" @bind="@fecha"></p>
        <p>Digite su Telefono: <input type="text" @bind="@telefono"></p>
        <p>
            Vacuna<select class="form-select form-select-sm" aria-label=".form-select-sm example" @bind="vacuna">
                <option selected>Vacunado</option>
                <option value="Sarampion">Sarampion</option>
                <option value="Rotavirus">Rotavirus</option>
                <option value="viruela">Viruela</option>
                <option value="Fiebre amarilla">Fiebre Amarilla</option>
                <option value="Rabia">Rabia</option>
                <option value="Polio">Polio</option>
                <option value="Gripe">gripe</option>
                <option value="Hepatitis A">Hepatitis A</option>
            </select>
        </p>
        <p>
            <select class="form-select form-select-sm" aria-label=".form-select-sm example" @bind="provincia">
                <option selected>Provincias</option>
                <option value="Azua-">Azua</option>
                <option value="Bahoruco">Bahoruco</option>
                <option value="Barahona">Barahona</option>
                <option value="Dajabon">Dajabon</option>
                <option value="Distrito Nacional">Distrito Nacional</option>
                <option value="Duarte">Duarte</option>
                <option value="Elias Piña">Elias Piña</option>
                <option value="El Seibo">El Seibo</option>
                <option value="Espaillat">Espaillat</option>
                <option value="Hato Mayor">Hato Mayor</option>
                <option value="Hermanas Mirabal">Hermanas Mirabal</option>
                <option value="Independencia">Independencia</option>
                <option value="La Altagracia">La Altagracia</option>
                <option value="La Romana">La Romana</option>
                <option value="La Vega">La Vega</option>
                <option value="Maria Trinidad Sanchez">Maria Trinidad Sanchez</option>
                <option value="Monseñor Nouel">Monseñor Nouel</option>
                <option value="Monte Cristi">Monte Cristi</option>
                <option value="Monte Plata">Monte Plata</option>
                <option value="Pedernales">Pedernales</option>
                <option value="Peravia">Peravia</option>
                <option value="Puerto Plata">Puerto Plata</option>
                <option value="Samana">Samana</option>
                <option value="Sanchez Ramirez">Sanchez Ramirez</option>
                <option value="San Cristobal">San Cristobal</option>
                <option value="San Jose de Ocoa">San Jose de Ocoa</option>
                <option value="3">San Juan</option>
                <option value="San Juan">San Pedro de Macoris</option>
                <option value="Santiago">Santiago</option>
                <option value="Santiago Rodrigez">Santiago Rodrigez</option>
                <option value="Santo Domingo">Santo Domingo</option>
                <option value="Valverde">Valverde</option>

            </select>
        </p>

    }

}
else if (validacion == 2)
{
    <p>Esta cedula no es dominicana</p>
}


@code {
    registro_vacunasContext db = new registro_vacunasContext();
    Vacunas vacunas = new Vacunas();

    string cedula;
    int producto;
    int numeroValidacion;
    string subCedula;
    int numCedula;
    int multiplicacion;
    int sumatotal;
    string dato;
    string link = "https://api.adamix.net/apec/cedula/";
    string api;
    string json;
    string nombre ="";
    string apellido;
    string fecha;
    string telefono;
    string vacuna;
    string provincia;
    DateTime first_dosis = DateTime.Now;
    CedulaApiResponse res;

    int validacion;

    int[] constante = { 1, 2, 1, 2, 1, 2, 1, 2, 1, 2 };

    void ValidarCedula()
    {
        if (cedula.Length != 11)
        {
            validacion = 2;
        }
        else
        {
            try
            {
                var cedual = Int64.Parse(cedula);
            }
            catch (FormatException e)
            {
                validacion = 3;
                return;
            }


            numeroValidacion = Int32.Parse(cedula.Substring(10));
            subCedula = cedula.Substring(0, 10);

            for (int i = 0; i < subCedula.Length; i++)
            {

                numCedula = (int)Char.GetNumericValue(subCedula[i]);
                multiplicacion = numCedula * constante[i];
                dato = multiplicacion.ToString();

                int listaSuma = 0;


                for (int num = 0; num < dato.Length; num++)
                {
                    listaSuma += (int)Char.GetNumericValue(dato[num]);


                }
                sumatotal += listaSuma;

            }

            int residuo = sumatotal % 10;
            int numeroValidar = 10 - residuo;

            if (numeroValidar == numeroValidacion)
            {
                validacion = 1;
                ReadApi();
            }
            else
            {
                validacion = 2;
            }
        }
    }

    void ReadApi()
    {


        try
        {
            var cedual = Int64.Parse(cedula);
        }
        catch (FormatException e)
        {

            return;
        }

        api = link + cedula;

        json = new WebClient().DownloadString(api);

        res = JsonConvert.DeserializeObject<CedulaApiResponse>(json);

        nombre = res.Nombres;
        apellido = res.Apellido1 + " " + res.Apellido2;
        fecha = res.FechaNacimiento.Substring(0, 10);

    }

    void Registrar()
    {
        vacunas.cedula = cedula;
        vacunas.nombre = nombre;
        vacunas.apellido = apellido;
        vacunas.fecha = fecha;
        vacunas.telefono = telefono;
        vacunas.vacuna = vacuna;
        vacunas.provincia = provincia;
        vacunas.first_dosis = first_dosis;
        db.Add(vacunas);
        db.SaveChanges();
        
    }
}

